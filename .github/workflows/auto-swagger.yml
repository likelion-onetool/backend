# .github/workflows/auto-swagger.yml
name: Auto Swagger Annotation

on:
  pull_request:
    paths:
      - 'src/main/java/com/onetool/server/api/**/controller/**.java'

jobs:
  auto-swagger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install google-generativeai

      - name: Run AI Annotation Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Find modified controller files
          git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep 'src/main/java/com/onetool/server/api/.*/controller/.*\.java' > modified_controllers.txt
          
          # Run python script to add annotations
          python .github/scripts/auto_swagger.py modified_controllers.txt

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "feat: Add/Update Swagger annotations by Gemini AI" || echo "No changes to commit"
          git push

      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(comment => comment.user.login === 'github-actions[bot]');

            const body = `Gemini AI가 Swagger 애너테이션을 자동으로 추가/업데이트했습니다. 변경 사항을 확인해주세요.`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
